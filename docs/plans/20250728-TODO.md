# SimaCode 开发计划 - 双模式架构

**日期**: 2025-07-28  
**版本**: v2.0  
**架构**: SimaCode支持双模式运行 - 独立终端AI Agent + 后端API服务  

## 🎯 架构目标

SimaCode既可以作为独立的终端AI Agent应用直接使用，也可以作为后端API服务，为DevGenius Agent框架提供AI代理能力，通过RESTful API和WebSocket进行通信。这种双模式设计满足不同用户的使用场景。

## 📊 当前实现状态评估

### ✅ 已完全实现的核心组件 (70%完成度)

1. **ReAct Engine (推理行动引擎)** - 完整 ✅
   - 任务规划、执行引擎、结果评估、异常处理

2. **Tool System (工具系统)** - 基础完整 ✅
   - 文件操作、Shell执行、工具注册机制

3. **Security System (安全系统)** - 完整 ✅
   - 权限管理、路径验证、安全检查

4. **AI Integration (AI集成)** - 部分完整 ⚠️
   - ✅ OpenAI客户端、抽象接口、对话管理
   - ❌ 缺少其他AI提供商支持

5. **Configuration & Session Management** - 完整 ✅
   - 分层配置、会话持久化、状态管理

6. **CLI Layer** - 基础完整 ⚠️
   - ✅ 基本命令支持，保持现有功能  

## 🚨 双模式架构的缺失模块

### 1. **Web API Layer (Web接口层)** - 最高优先级 🔥
```
状态: 完全缺失
影响: 无法支持API服务模式，无法与DevGenius Agent集成
紧急程度: 极高
```

**需要实现的组件:**
- **FastAPI/Flask Web框架集成**
  - RESTful API endpoints
  - WebSocket支持 (实时聊天)
  - API版本控制
  - 请求/响应模型定义

- **核心API端点:**
  ```
  POST /api/v1/chat/                    # 单次对话
  POST /api/v1/chat/stream/             # 流式对话
  POST /api/v1/react/execute/           # ReAct任务执行
  GET  /api/v1/react/sessions/          # 会话列表
  POST /api/v1/react/sessions/          # 创建会话
  GET  /api/v1/react/sessions/{id}/     # 获取会话详情
  PUT  /api/v1/react/sessions/{id}/     # 更新会话
  DELETE /api/v1/react/sessions/{id}/   # 删除会话
  GET  /api/v1/tools/                   # 可用工具列表
  POST /api/v1/tools/{name}/execute/    # 直接执行工具
  GET  /api/v1/config/                  # 获取配置
  PUT  /api/v1/config/                  # 更新配置
  GET  /api/v1/health/                  # 健康检查
  ```

- **WebSocket端点:**
  ```
  WS /api/v1/chat/ws/                   # 实时聊天
  WS /api/v1/react/ws/                  # 实时ReAct执行
  ```

### 2. **API Documentation & Validation (API文档和验证)** - 高优先级 🔴
```
状态: 完全缺失
影响: DevGenius Agent无法正确集成
```

**需要实现:**
- OpenAPI/Swagger文档自动生成
- Pydantic请求/响应模型
- 输入验证和错误处理
- API测试套件

### 3. **Async Request Processing (异步请求处理)** - 高优先级 🔴
```
状态: 完全缺失
影响: 长时间ReAct任务会阻塞API
```

**需要实现:**
- 异步任务队列 (Celery/Redis)
- 任务状态跟踪
- 结果缓存
- 进度报告机制

## 🔧 双模式架构设计

### 1. **核心服务层抽取 (Core Service Layer)** - 高优先级 🔴
```
设计目标: 创建统一的核心服务层，支持CLI和API两种调用方式
实现方案: 抽取核心业务逻辑，提供统一接口
```

**架构设计:**
- 抽取ReAct引擎、工具系统等核心逻辑为服务层
- CLI模式直接调用核心服务
- API模式通过Web框架调用相同的核心服务
- 统一错误处理和响应格式

### 2. **双模式启动机制** - 高优先级 🔴
```
设计目标: 支持用户选择运行模式
实现方案: 统一入口点，根据参数选择运行模式
```

**启动模式:**
```bash
# 终端AI Agent模式 (默认)
simacode chat "帮我分析这个代码"
simacode react "创建一个Python项目"

# API服务模式
simacode serve --host 0.0.0.0 --port 8000
simacode api --config api_config.yaml
```

### 3. **会话管理双模式适配** - 中优先级 🟡
```
设计目标: 会话管理同时支持CLI和API模式
实现方案: 统一会话接口，支持不同的存储策略
```

**改进内容:**
- CLI模式：本地会话存储，单用户使用
- API模式：支持多用户并发会话，会话隔离
- 统一会话接口，便于模式切换
- 会话超时管理和内存优化

### 4. **ReAct引擎双模式支持** - 中优先级 🟡
```
设计目标: ReAct引擎同时支持同步和异步执行
实现方案: 提供统一执行接口，支持不同调用模式
```

**改进内容:**
- CLI模式：同步执行，实时输出
- API模式：异步执行，支持进度回调
- 统一任务接口，支持取消和状态查询
- 结果序列化优化

## 🚀 第二优先级的增强模块

### 1. **Multi-Provider AI Support (多AI提供商支持)** - 中优先级 🟡
```
目标: 支持更多AI提供商，提供灵活性
优先级: 在Web API完成后实施
```

**待添加提供商:**
- Anthropic Claude (优先)
- Google Gemini
- 本地模型支持 (Ollama)
- Azure OpenAI
- Mistral AI


## 🔧 第三优先级的系统优化

### 1. **Performance & Scalability (性能和可扩展性)** - 低优先级 🟢
- 请求缓存策略
- 数据库连接池
- 负载均衡支持
- 微服务架构准备

### 2. **Advanced Security (高级安全)** - 低优先级 🟢
- 代码执行沙盒增强
- 恶意代码检测
- 审计日志详细化
- 网络隔离

### 3. **Monitoring & Logging (监控和日志)** - 低优先级 🟢
- API性能监控
- 错误追踪
- 使用统计
- 健康检查增强

## 📅 开发里程碑计划

### Phase 1: 双模式基础架构 (4-6周) 🎯
**目标**: 建立核心服务层和双模式支持

- [ ] **Week 1-2**: 核心服务层抽取
  - [ ] 项目架构重构
  - [ ] 核心服务接口设计
  - [ ] ReAct引擎服务化
  - [ ] 工具系统服务化

- [ ] **Week 3-4**: API模式实现
  - [ ] FastAPI框架集成
  - [ ] RESTful API端点实现
  - [ ] WebSocket实时通信
  - [ ] 异步任务处理

- [ ] **Week 5-6**: 双模式完善
  - [ ] CLI模式优化
  - [ ] 启动机制统一
  - [ ] 配置管理统一
  - [ ] 错误处理完善

### Phase 2: 核心功能增强 (2周)
**目标**: 完善AI集成

- [ ] **Week 7-8**: 多AI提供商支持
  - [ ] Anthropic Claude集成
  - [ ] Google Gemini集成
  - [ ] 提供商切换机制

### Phase 3: 系统完善 (1-2周)
**目标**: 性能优化和监控

- [ ] **Week 9-10**: 性能优化
  - [ ] 缓存策略
  - [ ] 性能监控
  - [ ] 负载测试
  - [ ] 错误处理完善

## 🎯 双模式使用场景

### 终端AI Agent模式
**适用场景:** 开发者直接使用，本地开发环境
**特点:**
- 即开即用，无需额外配置
- 实时交互，直接命令行操作
- 本地会话存储，单用户使用
- 丰富的终端UI展示

### API服务模式
**适用场景:** 集成到其他系统，如DevGenius Agent
**特点:**
- RESTful API + WebSocket支持
- 多用户并发，会话隔离
- 异步任务处理，适合长时间操作
- 标准化接口，易于集成

### DevGenius Agent 集成要求

#### API设计原则
1. **RESTful设计**: 遵循REST最佳实践
2. **异步优先**: 长时间操作必须异步处理
3. **实时通信**: WebSocket支持实时状态更新
4. **错误处理**: 统一的错误格式和状态码
5. **版本控制**: API版本化支持向后兼容

#### 关键集成点
1. **双模式兼容**: API和CLI共享相同的核心能力
2. **会话管理**: 支持多用户会话隔离
3. **文件系统**: 安全的文件操作权限管理
4. **实时反馈**: 任务执行进度实时推送

## 📈 成功指标

### Technical KPIs
- [ ] API响应时间 < 200ms (95%请求)
- [ ] WebSocket连接稳定性 > 99.5%
- [ ] 并发用户支持 > 100
- [ ] API测试覆盖率 > 90%

### Integration KPIs  
- [ ] 双模式功能一致性验证
- [ ] DevGenius Agent集成成功
- [ ] CLI模式用户体验优化
- [ ] 跨平台兼容性验证
- [ ] 安全审计通过
- [ ] 性能基准测试通过

## 🔧 技术栈建议

### 新增技术组件
- **Web框架**: FastAPI (推荐) 或 Flask
- **异步处理**: Celery + Redis
- **数据库**: PostgreSQL (生产) + SQLite (开发)
- **文档**: FastAPI自动生成 + Swagger UI
- **测试**: pytest + httpx (API testing)
- **部署**: Docker + Docker Compose

### 保留现有技术
- **Python 3.10+**
- **Pydantic** (API模型验证)
- **Rich** (日志格式化)
- **Click** (保留CLI支持)

## 📝 总结

基于双模式架构的设计，SimaCode既保持了作为独立终端AI Agent的优势，又具备了作为后端API服务的能力。这种设计满足了不同用户的使用需求，既可以直接使用，也可以集成到DevGenius Agent等更大的系统中。

**关键成功因素:**
1. 建立统一的核心服务层，确保双模式功能一致性
2. 优化用户体验，CLI模式简单易用，API模式标准化
3. 保持现有ReAct引擎和工具系统的核心优势
4. 建立可扩展的架构基础，支持未来功能扩展

**架构优势:**
- **灵活性**: 用户可根据场景选择合适的使用模式
- **一致性**: 两种模式共享相同的核心能力和业务逻辑
- **可扩展**: 统一的服务层便于功能扩展和维护
- **兼容性**: 既满足个人开发者需求，也支持企业级集成
